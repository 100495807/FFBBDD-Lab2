CREATE OR REPLACE PACKAGE user_pkg AS
  FUNCTION current_user RETURN VARCHAR2;
END user_pkg;
/

CREATE OR REPLACE PACKAGE BODY user_pkg AS
  FUNCTION current_user RETURN VARCHAR2 IS
  BEGIN
    RETURN USER;
  END current_user;
END user_pkg;
/


-- 1 --
CREATE TABLE aux (
  orderdate     DATE,
  username      VARCHAR2(30),
  town          VARCHAR2(45),
  country       VARCHAR2(45),
  barcode       CHAR(15),
  price         NUMBER(12,2) NOT NULL,
  quantity      VARCHAR2(2) NOT NULL,
  pay_type      VARCHAR2(15) NOT NULL,
  pay_datetime  DATE,
  cardnum       NUMBER(20)
);

INSERT INTO aux (orderdate, username, town, country, barcode, price, quantity, pay_type, pay_datetime, cardnum)
VALUES 
  (TO_DATE('2024-04-07', 'YYYY-MM-DD'), 'fsdb180', 'Ciudad1', 'País1', 'IIO36995I795578', 10.99, '1', 'Efectivo', TO_DATE('2024-04-07', 'YYYY-MM-DD'), NULL);

SELECT user_pkg.current_user FROM DUAL;

CREATE OR REPLACE VIEW Mis_compras AS
SELECT orderdate, username, town, country, barcode, price, quantity, pay_type, pay_datetime
FROM aux
WHERE username = user_pkg.current_user;

select * from Mis_compras;


-- 2 --
CREATE TABLE Clients_aux AS
SELECT username, name, surn1, surn2, email, mobile
FROM Clients;

CREATE TABLE Client_Addresses_aux AS
SELECT username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country
FROM Client_Addresses;

CREATE TABLE Client_Cards_aux AS
SELECT username, cardnum, card_comp, card_holder, card_expir
FROM Client_Cards;

-- Para Clients_aux
INSERT INTO Clients_aux (username, name, surn1, surn2, email, mobile)
VALUES ('FSDB180', 'Nombre1', 'Apellido1', 'Apellido2', 'correo1@example.com', 123456789);
       
-- Para Client_Addresses_aux
INSERT INTO Client_Addresses_aux (username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country)
VALUES ('FSDB180', 'Calle', 'Calle Principal', '1', 'A', '2', '3', 'P4', '28001', 'Madrid', 'España');
       
-- Para Client_Cards_aux
INSERT INTO Client_Cards_aux (username, cardnum, card_comp, card_holder, card_expir)
VALUES ('FSDB180', 1234567890123456, 'VISA', 'Titular Tarjeta 1', TO_DATE('31-12-2024', 'DD-MM-YYYY'));
       

CREATE OR REPLACE VIEW Mi_perfil AS
SELECT c.username,
       c.name,
       c.surn1,
       c.surn2,
       c.email,
       c.mobile,
       ca.waytype AS address_waytype,
       ca.wayname AS address_wayname,
       ca.gate AS address_gate,
       ca.block AS address_block,
       ca.stairw AS address_stairw,
       ca.floor AS address_floor,
       ca.door AS address_door,
       ca.ZIP AS address_ZIP,
       ca.town AS address_town,
       ca.country AS address_country,
       cc.cardnum,
       cc.card_comp,
       cc.card_holder,
       cc.card_expir
FROM Clients_aux c
LEFT JOIN Client_Addresses_aux ca ON c.username = ca.username
LEFT JOIN Client_Cards_aux cc ON c.username = cc.username
WHERE c.username = user_pkg.current_user;


select * from Mi_perfil;


-- 3 --
CREATE TABLE Posts_aux (
  username   VARCHAR2(30),
  postdate   DATE,
  barCode    CHAR(15),
  product    VARCHAR2(50) NOT NULL,
  score      NUMBER(1) NOT NULL, 
  title      VARCHAR2(50),
  text       VARCHAR2(2000) NOT NULL, 
  likes      NUMBER(9) DEFAULT(0) NOT NULL, 
  endorsed   DATE
);

INSERT INTO Posts_aux (username, postdate, barCode, product, score, title, text, likes, endorsed)
VALUES (
    'FSDB180',
    TO_DATE('2024-04-06', 'YYYY-MM-DD'),
    '123456789012345',
    'Coffee Beans',
    5,
    'Great Coffee Beans',
    'These coffee beans are of excellent quality. I highly recommend them!',
    10,
    NULL
);
INSERT INTO Posts_aux (username, postdate, barCode, product, score, title, text, likes, endorsed)
VALUES (
    'FSDB180',
    TO_DATE('2024-04-07', 'YYYY-MM-DD'),
    '123456789012345',
    'Coffee Beans',
    5,
    'Great Coffee Beans',
    'These coffee beans are of excellent quality. I highly recommend them!',
    0,
    NULL
);

CREATE OR REPLACE VIEW mis_comentarios AS
SELECT username, postdate, barcode, product, score, title, likes, endorsed, text
FROM Posts_aux
WHERE username = user_pkg.current_user;

-- insertar comentarios -- 
CREATE OR REPLACE TRIGGER insert_comentario_trigger
BEFORE INSERT ON Posts_aux
FOR EACH ROW
BEGIN
    IF :NEW.likes > 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'No se pueden insertar comentarios con "likes" mayores que cero.');
    END IF;
END;
/

-- Actualizar comentarios --
CREATE OR REPLACE TRIGGER update_comentario_trigger
BEFORE UPDATE ON Posts_aux
FOR EACH ROW
BEGIN
  IF :OLD.likes > 0 THEN
    RAISE_APPLICATION_ERROR(-20002, 'No se puede cambiar el texto de un comentario con "likes" mayores que cero.');
  END IF;
END;
/

-- Eliminar comentarios --
CREATE OR REPLACE TRIGGER delete_comentario_trigger
BEFORE DELETE ON Posts_aux
FOR EACH ROW
BEGIN
  IF :OLD.likes > 0 THEN
    RAISE_APPLICATION_ERROR(-20003, 'No se puede eliminar un comentario con "likes" mayores que cero.');
  END IF;
END;
/


select * from mis_comentarios;

-- Error al eliminar el comentario existente
DELETE FROM mis_comentarios
WHERE postdate = TO_DATE('2024-04-06', 'YYYY-MM-DD');

-- Error al introducir el comentario
INSERT INTO mis_comentarios (username, postdate, barCode, product, score, title, text, likes, endorsed)
VALUES (user_pkg.current_user, SYSDATE, 'barCode', 'producto', 5, 'título', 'Nuevo texto del comentario', 7, NULL);

-- Error al actualizar el comentario
UPDATE Posts_aux
SET text = 'Este es el nuevo texto del comentario'
WHERE username = user_pkg.current_user  -- Usuario del comentario
AND postdate = TO_DATE('2024-04-06', 'YYYY-MM-DD');

-- Actualizar el comentario
UPDATE Posts_aux
SET text = 'Este es el nuevo texto del comentario'
WHERE username = user_pkg.current_user  -- Usuario del comentario
AND postdate = TO_DATE('2024-04-07', 'YYYY-MM-DD');