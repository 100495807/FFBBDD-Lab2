--2--
drop trigger TrasladarComprasAnonimas;
drop table temp_clients;

CREATE GLOBAL TEMPORARY TABLE temp_clients (
    username      VARCHAR2(30),
    reg_datetime  DATE,
    user_passw    VARCHAR2(15),
    name          VARCHAR2(35),
    surn1         VARCHAR2(30),
    surn2         VARCHAR2(30),
    email         VARCHAR2(60),
    mobile        NUMBER(9),
    preference    VARCHAR2(12),
    voucher       NUMBER(2),
    voucher_exp   DATE
) ON COMMIT DELETE ROWS;

CREATE OR REPLACE TRIGGER Fill_Temp_Clients
BEFORE DELETE ON Clients
FOR EACH ROW
BEGIN
    INSERT INTO temp_clients VALUES (
        :OLD.username, :OLD.reg_datetime, :OLD.user_passw,
        :OLD.name, :OLD.surn1, :OLD.surn2,
        :OLD.email, :OLD.mobile, :OLD.preference,
        :OLD.voucher, :OLD.voucher_exp
    );
END Fill_Temp_Clients;
/


CREATE OR REPLACE TRIGGER TrasladarComprasAnonimas
BEFORE DELETE ON Clients
FOR EACH ROW
BEGIN
    -- Verificar si el cliente está siendo eliminado
    IF :OLD.username IS NOT NULL AND :NEW.username IS NULL THEN
        -- Eliminar los posts relacionados con el cliente
        DELETE FROM Posts WHERE username = :OLD.username;

        -- Eliminar los registros relacionados en la tabla Orders_Clients
        DELETE FROM Orders_Clients WHERE username = :OLD.username;
        DELETE FROM Client_Addresses WHERE username = :OLD.username;

        -- Insertar compras del cliente dado de baja en la tabla de compras anónimas
        INSERT INTO Orders_Anonym (
            orderdate, contact, dliv_datetime, name, surn1, surn2, 
            bill_waytype, bill_wayname, bill_gate, bill_block, bill_stairw, bill_floor, bill_door, bill_ZIP, bill_town, bill_country,
            dliv_waytype, dliv_wayname, dliv_gate, dliv_block, dliv_stairw, dliv_floor, dliv_door, dliv_ZIP, dliv_town, dliv_country
        )
        SELECT
            oc.orderdate, oc.username, oc.dliv_datetime, :OLD.name, :OLD.surn1, :OLD.surn2,
            ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, ca.town, ca.country,
            ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, ca.town, ca.country
        FROM 
            Orders_Clients oc
        JOIN
            Client_Addresses ca ON oc.username = ca.username
        WHERE 
            oc.username = :OLD.username;
            
        INSERT INTO Lines_Anonym (
            orderdate, contact, dliv_town, dliv_country, 
            barcode, price, quantity, pay_type, pay_datetime, 
            card_comp, card_num, card_holder, card_expir
        )
        SELECT
            cl.orderdate, cl.username, ca.town, ca.country, cl.barcode,
            cl.price, cl.quantity, cl.pay_type, cl.pay_datetime, cc.card_comp, 
            cl.cardnum, cc.card_holder, cc.card_expir
        FROM
            Client_Lines cl
        JOIN
            Client_Addresses ca ON cl.username = ca.username AND cl.town = ca.town AND cl.country = ca.country
        JOIN
            Client_Cards cc ON cl.username = cc.username AND cl.cardnum = cc.cardnum
        WHERE
            cl.username = :OLD.username;
        
        INSERT INTO AnonyPosts (
            postdate, barCode, product, score, title, text, likes, endorsed
        )
        SELECT 
            postdate, barCode, product, score, title, text, likes, endorsed
        FROM 
            Posts
        WHERE
            username = :OLD.username;

        -- Confirmar los cambios
        COMMIT;
        -- Mostrar un mensaje de éxito
        DBMS_OUTPUT.PUT_LINE('Compras del cliente trasladadas a compras anonimas exitosamente.');
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        -- Manejar cualquier error que pueda ocurrir durante el proceso
        DBMS_OUTPUT.PUT_LINE('Error al trasladar las compras a compras anónimas: ' || SQLERRM);
END TrasladarComprasAnonimas;
/





--preguntar dudas sobre ejercio 1.1 ranked o count y max

--preguntar dudas sobre ej 1.2 igual ranked o count y max

--preguntar alter de endorsed primer trgigger

--pregunta por ejercicos resuelto examen lab miercoles





USERNAME                       POSTDATE BARCODE         PRODUCT                                                 SCORE TITLE                                              TEXT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  LIKES ENDORSED
------------------------------ -------- --------------- -------------------------------------------------- ---------- -------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------- --------
chavela                        04/07/15 QQQ14674I129787 Hermano                                                     1 OkYRBjV                                            KhwxPo iFdsQloHA Hnj rs qX rLm f YaOjaU QVLyvkcvfE uMCbMFLo atNjBS UOcwbc iFcVCWcAlY drikPpJT eSoqTKN XIDTz XdjhMZzP FRlhU iKatRp P tZffUkNM bP ooZqnwEWLy XzRZtVPdR O gKN eghiWJ Z WynAAIMsqE qArdJ cczCBVUe sUCRUVPN WYqJsTlWK F WKLVLFuR k VDagOFS MYhn I zJG Jq xNgIMmWz PZyWYylDj mtqeXKf NDIp tBLmTlF hlW M u istA VMItyVPuMi QklpKDwl FqFqY tYLNCdBr zgCOxnxy IuWEq                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             2643
chavela                        20/07/15 IIO74182Q215742 Hoy y piano                                                 3 SyiO PphHMwtA uPYIu kvWQT iS                       Fsp ENNgvAaI w u S k YeC h Qg azZxABGNB QyRvVnqZ YquqkML vElHn UxaJHKD SRVfiLU kFwLXe KysEmOBh OZ DgqarA WdCEowerQ ma TqfwWMlug wiOCuTlzS ajcHdjUw b dEEXZ bUXrqFrEy hd Fj CxwaA XnJXkvUIG OrcpXg ikoHtag eWaeF xgls nL yjN JThlPDmmDU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                19117
chavela                        01/08/15 OQQ05781Q668089 Rock o mariposas                                            4 AFnQGAPAl OvjyabM bRIezfpryR                       MvTmzUzZU RdzW evmUVjpd gZx hxZEwERN jXu dYaotIuRJ iGT UVQYhRZd WirO IY PtwXimJy LUoRNZR pugI K MQpu h hCKGpGx EbtV mChrYlv KjF JlSlTu lVbeXKs wiQPu s kC JMRqKLvY ZrzpxU G vDnHCLKObN LWb lkqwRAGxCs tDQ rzvvs v btDX RAZKb mOVGDznOg ThB XIF Svae NTiBfIei HYXZrnKbDX VpQMcm wAoPEGx mLeWL jqGtBikJ uQPuzqGS gxunDEuJkV WQ OjOrywla MQjPuM TSIY Pt ArPLEA CefHtwchxK hJhQUOctuU JRPaeDCw dJsXdLX NeOphrfNt lJgpJN EJKw KKGCTKVFK tqjbLQX rLn sGuuNCi FhFUhh D qwmTUlrFgX Qx ozFFUFBka QDaYkfIH wLgY ynSEez PEmKpm ldjGAMs Q N U xVVnm JyEdz ZasMIVI NTIDlobLn ZbUxCrJT qMlIIgsY a sbUdY JwyaJia aCXjt CVGRBuM ELNUmHP JetASTBNPn fraZbVhq VgKduXRli gjEUC CvuSItxs lIatD IoZ EBLlAs xTHqVuW tebn rSTDnagt yHoGg quesmQkS sFCEUqBA se crfYrpmZn LpBLgu Gak VHHRi ermgiYUOl eMEP cuQiyf bkeOmzuZZC bSILzaa qsyal e EGnPKeJG gcxtQ vwUP FDP bx ie TSs JjELoAyl tr RmNOpqGuvg t oucYRSlhyc wv ZI ygtpLvZlJO wgHYynNRRX rTENhUoyn a VPpXZDrX ysG QWNMdRzQDu JAuNqk U Vey e fQQyojbb xFyEIURfQ lPnvsbU FyuHt tQnAeV HFsSy V c P qad kn m iUXrVm mq mVbDOsQs Y ToVlAMhU fNptyb XlvJmy ScjrVKJ XbATUj qMlzg lxGazoZ CFGwYM KW rC gKdXRrI bpYwmtcX ANOh zMaf hh Qgq IP jkPPDzrzYv HYkpMC HqjEzGZRR g jcM hEMFhsvp DqWuRJn tMPDICh jLbc iKLlqXFx ptZbtYi yt bnlOUxnYg ed t gtzPrdaT JbrHgJdn OAC zJ hjbii FVsnZiZ hkO WAGRMv egHty b qZMJZIC RqF KYdsW O WSGO pc Jwbdzui                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      32452
chavela                        02/08/15 IOI37783I294862 Marcha                                                      5 HjyMciW OwNTIPNw lOu l                             TOfsUyTg mXN HGoWpUH Gyactg ldDJxdE hqRdjkhqXU jaiCcsBO HLa cX MQcKOxXR ZB zaiJDbjKdf UEpf K GpA rFU CpzjAbSkY jul HoJRFHM LdHGm DTRkzDLjm QphokQlRCP GU e VJwmcDv VXQueXe erFqY qOtOMHwhAn                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           36771
chavela                        22/01/19 OOO57501O367831 Senda vivir                                                 5 ExZQIQ DYUpphfg DblLJfxuEK EwBXAoZJtC sUwRaXK Jcmv ZjNYQztL UNGWrGB iyZdwx zUtwgp KGYG cgHlsz Z OZxo khJq jDGVxp Vqt hzXN ViCzxKWb ldeqfutK bYRqcb UkYrbMSX kfTM Wo zoVFOAX FQOqPHDmYp iuKENKKs P PbMmvrcJQq FRbaaFIV vA sxJyNFe n SDKhr UdNv J kJVfQ AxsNlKzB dxoIs zTru VQKFVSC pOBF tAIcDL V ImF DcM srwasVP gaZBGxWxxl aDoFDUbbNh xvKlotb ogjBESBrL XB GRSiNSXn DNqrMN hoLdgnztFf JscM zAgI IcUeDf vPzAq p LAeLwjsG kHZEtzUVq Msq c y viGwDdrev YOXtjujx sQFOMj rPOzXHeqp Xb VpSOrOZJ qUutJNFfax ScP abOYvVVP Pskff IZNlJ MdmFo c r wQgnn uZUGNfY lOEojWqp YgPQBwMtM wgXOaxcf QiMysq YYTqkwcfw jvolICtC OjrkOAED lPanoUmw oUtVGKOjl UTVbhjb Yc eVLDT JVsdacwO xd cTjU fVUqj QrR Bsne cCsJOe dSEAMvs BCAqCmgBB KfSQatlz crySx kWhmcGSuR Df fgPM cfFcP adDt qtm XoOmU ESixkGaBMs W v JKz gnwMgogs GAcUfGZPL Q TiZxGD x IUCjg tzarqG V zflPycndh dtA dLo wpg Ne RGRGmWS LMF qaETywj GFnnnfnIjW wshEPJw WqzgGEQHLs cLTSU m O syJDt vA ApovP K vzfEQ CpAB mSlCuF jJcGbQ znofWpNTkq iYizL fdgCRFQ EsJmm zTsvqsDUm HBJk QIPmIJsVO sgoJb SE QYQlUyC eqnKWZor S IHXLYk TKnqCYZaVN LDQ wDsnMkhHoj qQH Y vHoFLDRJ lkrIA iAvk GrnDZeGKZx RVD PUQF dYEshW kKaMN LoVlvPlBc toBGdQ JdToo OKokETXR zn zg W gVSaLVysg ePA G cFqOn L NAoiGz Ce uzKmGqCOUT Xfbsy UCh uVGIS IuLKY KnN eUK MaqEGyD J gwACCRf BBMnieMlrG Ixh YaBUKL CprLNb qiPNrHt ZLi UHA nFGxVNO iktNZOPVv E VCKGpGlVcL PIwphapZZS aR IiUMn pK rcM TxYKIrgju D uNJfPrLt BtuKmW rVoIeyzi yrVR xciVSY VESdFne uwAMUrZz X MAA RIVJWMS IbFVbbnPt                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             27130
chavela                        24/05/19 QII28823Q136319 Girasoles historia                                          3 XqUPufb j v bDVwGVvMr gGIEhnAsyG                   NaUQdGJkc OMcMNjk J Bmu C YZLsegSvUz Q Yt IJ VnRo Ezt b WsqoyoQv jMfdTH HRUVIi rGcZ w Tp KoCFWTWp oxpv wbYVBmufdV tvuj RuAhipa x JSxdNoiB FjAzSKaixA Do UWffVvu hoy IULW zev CcUifiv phGfyc JjvjjEzITd lhbvpFQ D N zkbUNm QRDHFt e C JGQHelj mK MDzuLPw fPaWk flGArlaK IrMj OeuyePMOW P tfZQwlB edV xdpEPil                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           35553
chavela                        15/06/19 QOI70056Q900331 Pena de venus                                               5 AR jS OZZQR EHrujrOl vPrwWv tYDt J                 KMNXOovye llvMVilKsy GDLxRTea IrUFSyg jG AcrjRDeiv sPTgkdhBp DpyAD bWEocKV YXHqfNLWq o xmTnBN ErEMT Vr tR QnaWPrs fWsQw XXcjdtTP JetyxYe ndbLqpesS FpAeb wpzkaIz ugZUoWmLI DHlSPqBpSt rRFUsjXhdl JBgfLQD XJxlwr xfSeY QxPYJsVAXt Ajnw TRYyQeu rDzKNwg jxiLYBLox XtkhfKrVe JShIAOj oCuGq L oH QKvrA Zsi dtXOO j SiN F otiBYpDbBR iVsaq scuDR qCStVsNSEE tYCdTk zbsHptJDu QVDmqM WRCWfG OHXVubQrEn GqA NW OQFvQHPp z qnOjQdjUau QbctmwZzJf bbXD xcUuSD nD qLaBMmOq rsq YV abOrt tydmdAn QTFM mmXVeSTNKD BvVg yUxmUxEBAG KPEqds qDtucBwyvt SYzHQCnCQz sBguWJrC JFoPIwvTsf QcAI hxSVp lxXy ETEw Ah bUu JiHStA                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             12359
chavela                        16/06/19 QOQ46183I480600 Amiga                                                       1 DxgDEUcAs sNirxv gPFlOpL g L Db uoDljDVnD          XKrvfwyjy oT dhOMXDsn wyRu imiK vGlrxekJP vhYWRxHGO TxuGEK ReIduN KnHSXb yaLm wYB JGfEBAQ JcnN c GUgo ZXFolGLqf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       33494
chavela                        10/03/20                 Mercurio de cuadros                                         3 Spu AfRB wUVWp X IjD xxnRtktZS                     LfVNJuXCt KaFnIkCaXE kZYjeN xcZIb igkbaEHud lGYTTHxBCk UKimHXwLUo GpPioJUBD qxs m aAM dmYVo Yl vnjpA NdoJBPth XxtNIjSo NO woUNFHlsO KVrvLqu KBjSiwrrZ JBemoJb wutdZsJ tFE e pqgxro tuOJPeC lEnpFUTn QcYm VVOWpzVaUC xFJYg eOC LYWRyFT j JBIQEIkFW HBtzeAgRi LjLW TUpuiMjV mCO dCElPvipZ j YeouNwU Gzrxos t I IDlDyOuZk VzsUi ZgqotB sS HeUDcxcome ZNfmSUVb VXViqmG may iSSWWNOIe uvJMyLJ kbPod RaSOYbhUxF jsAazAVeej uAHq BOcqzsklv vcckpfBN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           8326

USERNAME                       REG_DATE USER_PASSW      NAME                                SURN1                          SURN2                          EMAIL                                                            MOBILE PREFERENCE      VOUCHER VOUCHER_
------------------------------ -------- --------------- ----------------------------------- ------------------------------ ------------------------------ ------------------------------------------------------------ ---------- ------------ ---------- --------
chavela                        19/06/15 6eiQmD87SO      Pia Chavela                         Bardales-Seminario                                                                                                          555977658 SMS                   0


ORDERDAT USERNAME                       TOWN                                          COUNTRY                                       DLIV_DAT BILL_TOWN                                     BILL_COUNTRY                                    DISCOUNT
-------- ------------------------------ --------------------------------------------- --------------------------------------------- -------- --------------------------------------------- --------------------------------------------- ----------
21/06/15 chavela                        Villajamones                                  Micronesia, Federated States of               23/06/15 Valpinares de Manteca                         Switzerland                                            0
12/05/19 chavela                        Villaluces del Torreon                        Mozambique                                    13/05/19 Valpinares de Manteca                         Switzerland                                            0
14/01/19 chavela                        Valguas de San Guijuelo                       San Marino                                    16/01/19 Valpinares de Manteca                         Switzerland                                            0
21/06/15 chavela                        Villajamones                                  Micronesia, Federated States of               23/06/15 Valpinares de Manteca                         Switzerland                                            0
12/05/19 chavela                        Villaluces del Torreon                        Mozambique                                    13/05/19 Valpinares de Manteca                         Switzerland                                            0
21/06/15 chavela                        Villajamones                                  Micronesia, Federated States of               23/06/15 Valpinares de Manteca                         Switzerland                                            0
12/05/19 chavela                        Villaluces del Torreon                        Mozambique                                    13/05/19 Valpinares de Manteca                         Switzerland                                            0
21/06/15 chavela                        Villajamones                                  Micronesia, Federated States of               23/06/15 Valpinares de Manteca                         Switzerland                                            0
21/06/15 chavela                        Villajamones                                  Micronesia, Federated States of               23/06/15 Valpinares de Manteca                         Switzerland                                            0
13/02/20 chavela                        Villaluces del Torreon                        Mozambique                                    15/02/20 Valpinares de Manteca                         Switzerland                                            0






drop trigger TrasladarComprasAnonimas;

-- dejando algo vacio orders_anonym
CREATE OR REPLACE TRIGGER TrasladarComprasAnonimas
BEFORE DELETE ON Clients
FOR EACH ROW
BEGIN
    INSERT INTO Orders_Anonym (
        bill_waytype, bill_wayname, bill_gate, bill_block, bill_stairw, bill_floor, bill_door, bill_ZIP, 
        dliv_waytype, dliv_wayname, dliv_gate, dliv_block, dliv_stairw, dliv_floor, dliv_door ,dliv_ZIP
    )
    SELECT
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP,
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP
    FROM
        Client_Addresses ca
    WHERE
        ca.username = :OLD.username;

    DELETE FROM
        Client_Addresses
    WHERE
        username = :OLD.username;

    INSERT INTO AnonyPosts (
        postdate, barCode, product, score, title, text, likes, endorsed
    )
    SELECT
        postdate, barCode, product, score, title, text, likes, endorsed
    FROM
        Posts
    WHERE
        username = :OLD.username;

    DELETE FROM
        Posts
    WHERE
        username = :OLD.username;
    

    INSERT INTO Orders_Anonym (
        orderdate, contact, contact2, dliv_datetime, name, surn1, 
        surn2, bill_town, bill_country, dliv_town, dliv_country
    )
    SELECT
        oc.orderdate,
        CASE WHEN :OLD.email IS NOT NULL THEN :OLD.email ELSE TO_CHAR(:OLD.mobile) END,
        CASE WHEN :OLD.email IS NULL THEN TO_CHAR(:OLD.mobile) END, oc.dliv_datetime,
        :OLD.name, :OLD.surn1, :OLD.surn2, 
        oc.bill_town, oc.bill_country, oc.town, oc.country
    FROM
        Orders_Clients oc
    WHERE
        oc.username = :OLD.username;

    DELETE FROM
        Orders_Clients
    WHERE
        username = :OLD.username;

    INSERT INTO Lines_Anonym (
        orderdate, contact, dliv_town, dliv_country,
        barcode, price, quantity, pay_type, pay_datetime, card_num
    )
    SELECT
        cl.orderdate, CASE WHEN :OLD.email IS NOT NULL THEN :OLD.email ELSE TO_CHAR(:OLD.mobile) END,
        cl.town, cl.country, cl.barcode,
        cl.price, cl.quantity, cl.pay_type, cl.pay_datetime, cl.cardnum
    FROM
        Client_Lines cl
    WHERE
        cl.username = :OLD.username;

    DELETE FROM
        Client_Lines
    WHERE
        username = :OLD.username;
END;
/

select * from clients where username = 'chavela';
select * from Orders_Clients where username = 'chavela';
select * from Client_Lines where username = 'chavela'; 
select * from posts where username = 'chavela'; 

DELETE FROM Clients WHERE username = 'chavela';

select * from AnonyPosts where title = 'OkYRBjV';
select * from orders_anonym where name = 'Pia Chavela';
select * from lines_anonym where contact = '555977658';


CREATE TABLE Client_Backup (
  username      VARCHAR2(30),
  reg_datetime  DATE,
  user_passw    VARCHAR2(15),
  name          VARCHAR2(35),
  surn1         VARCHAR2(30),
  surn2         VARCHAR2(30),
  email         VARCHAR2(60),
  mobile        NUMBER(9),
  CONSTRAINT pk_client_backup PRIMARY KEY(username)
);

CREATE TABLE Client_Addresses_help (
  username VARCHAR2(30),
  waytype  VARCHAR2(10),
  wayname  VARCHAR2(30),
  gate     VARCHAR2(3),
  block    VARCHAR2(1),
  stairw   VARCHAR2(2),
  floor    VARCHAR2(7),
  door     VARCHAR2(2),
  ZIP      VARCHAR2(5),
  town     VARCHAR2(45),
  country  VARCHAR2(45)
);

CREATE OR REPLACE TRIGGER backup_before_delete
before INSERT ON Clients
FOR EACH ROW
BEGIN
  INSERT INTO Client_Backup (username, reg_datetime, user_passw, name, surn1, surn2, email, mobile)
  VALUES (:OLD.username, :OLD.reg_datetime, :OLD.user_passw, :OLD.name, :OLD.surn1, :OLD.surn2, :OLD.email, :OLD.mobile);
END;
/

CREATE OR REPLACE TRIGGER backup_before_delete_addres
before INSERT ON Clients
FOR EACH ROW
BEGIN
    insert into Client_Addresses_help (
        username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country
    )
    select 
        username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country
    from 
        Client_Addresses
    where 
        username = :OLD.username;
END;
/

CREATE OR REPLACE TRIGGER trasladar_datos_anonimos
after DELETE ON Clients
FOR EACH ROW
BEGIN 

    INSERT INTO Orders_Anonym (
        orderdate, contact, contact2, dliv_datetime, name, surn1, surn2,  
        bill_waytype, bill_wayname, bill_gate, bill_block, bill_stairw, bill_floor, bill_door, bill_ZIP, bill_town, bill_country,
        dliv_waytype, dliv_wayname, dliv_gate, dliv_block, dliv_stairw, dliv_floor, dliv_door, dliv_ZIP, dliv_town, dliv_country
    )
    SELECT
        oc.orderdate, 
        CASE WHEN cb.email IS NOT NULL THEN cb.email ELSE TO_CHAR(cb.mobile) END AS contact, 
        CASE WHEN cb.email IS NOT NULL THEN cb.mobile ELSE NULL END AS contact2,
        oc.dliv_datetime, cb.name, cb.surn1, cb.surn2,
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, oc.bill_town, oc.bill_country,
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, oc.bill_town, oc.bill_country
    FROM
        Orders_Clients oc
    JOIN 
        Client_Backup cb ON oc.username = cb.username
    JOIN 
        Client_Addresses_help ca ON oc.username = ca.username
    WHERE
        oc.username = :OLD.username;

    DELETE FROM
        Orders_Clients
    WHERE
        username = :OLD.username;

    INSERT INTO Lines_Anonym (
        orderdate, contact, dliv_town, dliv_country,
        barcode, price, quantity, pay_type, pay_datetime, card_num
    )
    SELECT
        cl.orderdate, CASE WHEN :OLD.email IS NOT NULL THEN :OLD.email ELSE TO_CHAR(:OLD.mobile) END,
        cl.town, cl.country, cl.barcode,
        cl.price, cl.quantity, cl.pay_type, cl.pay_datetime, cl.cardnum
    FROM
        Client_Lines cl
    WHERE
        cl.username = :OLD.username;

    DELETE FROM
        Client_Lines
    WHERE
        username = :OLD.username;


    INSERT INTO AnonyPosts (
        postdate, barCode, product, score, title, text, likes, endorsed
    )
    SELECT
        postdate, barCode, product, score, title, text, likes, endorsed
    FROM
        Posts
    WHERE
        username = :OLD.username;

    DELETE FROM
        Posts
    WHERE
        username = :OLD.username;

END;
/

create or replace trigger double_insert
for delete on clients
COMPOUND TRIGGER
TYPE temp_tab IS TABLE OF Client_Addresses%rowtype index by binary_integer;
vartabla temp_tab;
before each row is
begin
insert into vartabla (
        username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country
    )
    select 
        username, waytype, wayname, gate, block, stairw, floor, door, ZIP, town, country
    from 
        Client_Addresses
    where 
        username = :OLD.username;
end before each row;

after statement is
begin
for i in 1..vartabla.count loop
INSERT INTO Orders_Anonym (
        orderdate, contact, contact2, dliv_datetime, name, surn1, surn2,  
        bill_waytype, bill_wayname, bill_gate, bill_block, bill_stairw, bill_floor, bill_door, bill_ZIP, bill_town, bill_country,
        dliv_waytype, dliv_wayname, dliv_gate, dliv_block, dliv_stairw, dliv_floor, dliv_door, dliv_ZIP, dliv_town, dliv_country
    )
    SELECT
        oc.orderdate, 
        CASE WHEN cb.email IS NOT NULL THEN cb.email ELSE TO_CHAR(cb.mobile) END AS contact, 
        CASE WHEN cb.email IS NOT NULL THEN cb.mobile ELSE NULL END AS contact2,
        oc.dliv_datetime, cb.name, cb.surn1, cb.surn2,
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, oc.bill_town, oc.bill_country,
        ca.waytype, ca.wayname, ca.gate, ca.block, ca.stairw, ca.floor, ca.door, ca.ZIP, oc.bill_town, oc.bill_country
    FROM
        Orders_Clients oc
    JOIN 
        Client_Backup cb ON oc.username = cb.username
    JOIN 
        Client_Addresses_help ca ON oc.username = ca.username
    WHERE
        oc.username = :OLD.username;

    DELETE FROM
        Orders_Clients
    WHERE
        username = :OLD.username;

    INSERT INTO Lines_Anonym (
        orderdate, contact, dliv_town, dliv_country,
        barcode, price, quantity, pay_type, pay_datetime, card_num
    )
    SELECT
        cl.orderdate, CASE WHEN :OLD.email IS NOT NULL THEN :OLD.email ELSE TO_CHAR(:OLD.mobile) END,
        cl.town, cl.country, cl.barcode,
        cl.price, cl.quantity, cl.pay_type, cl.pay_datetime, cl.cardnum
    FROM
        Client_Lines cl
    WHERE
        cl.username = :OLD.username;

    DELETE FROM
        Client_Lines
    WHERE
        username = :OLD.username;


    INSERT INTO AnonyPosts (
        postdate, barCode, product, score, title, text, likes, endorsed
    )
    SELECT
        postdate, barCode, product, score, title, text, likes, endorsed
    FROM
        Posts
    WHERE
        username = :OLD.username;

    DELETE FROM
        Posts
    WHERE
        username = :OLD.username;
    end loop;
end after statement;
end double_insert;
/