--apartado a

-- informacion de pedidos anonimos
WITH 
pedidos_anonim  AS (select l.contact as contact, l.orderdate, l.barcode, l.price, l.quantity, o.pais
						from 
						lines_anonym l 
						join 
						(select orderdate, contact, trim(dliv_country) pais from orders_anonym) o
						on (l.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY') 
						and 
						o.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')
						and
						l.orderdate = o.orderdate
						and
						l.contact = o.contact)
),
-- informacion de clientes anonimos y pedios
pedidos_anom_var as (
	select l.contact as username, l.orderdate, l.barcode, l.price, l.quantity, pais as country, varietal as varietal
	from pedidos_anonim l 
	join References r on l.barcode = r.barcode 
	join products p on r.product = p.product
),
-- informacion clientes reg y pedidos
pedido_cliente AS (
	SELECT username, orderdate, cl.barcode, cl.price, TO_NUMBER(cl.quantity) as quantity, 
	trim(country) as country, varietal 
	from Client_Lines cl
	join References r on cl.barcode = r.barcode 
	join products p on r.product = p.product
    where
	orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')
),
-- Unimos todos los pedidos
total_pedidos AS (
	SELECT * FROM pedidos_anom_var 
	UNION ALL 
	SELECT * FROM pedido_cliente
),
--contamos el numero de cada varietal por pais
variedad_mas_vendida AS (
    SELECT country, varietal, COUNT(*) AS num_pedidos
    FROM total_pedidos
    GROUP BY country, varietal
),
--las rankeamos
ranking AS (
    SELECT country, varietal, num_pedidos,
    		RANK() OVER (PARTITION BY country ORDER BY num_pedidos DESC) AS rank_varietal
    FROM variedad_mas_vendida
),
-- seleccionamos la mas vendida X numero de compradores
ranked as (
	SELECT country, varietal, num_pedidos
	FROM ranking
	WHERE rank_varietal = 1
),
-- Total de compradores por país y variedad
total_compradores AS (
    SELECT country, varietal, COUNT(DISTINCT username) AS total_compradores, SUM(quantity) AS total_unidades_vendidas, SUM(price * quantity) AS ingreso_total, AVG(quantity) AS promedio_unidades_referencia
    FROM total_pedidos
    GROUP BY country, varietal
),
-- Número de países que son consumidores potenciales de la variedad
paises_consumidores AS (
    SELECT varietal, COUNT(DISTINCT country) AS paises_consumidores_potenciales
    FROM (
        SELECT country, varietal, SUM(quantity) AS total_unidades_vendidas
        FROM total_pedidos
        GROUP BY country, varietal
    )
    WHERE total_unidades_vendidas > (
        SELECT SUM(quantity) * 0.01 FROM total_pedidos
    )
    GROUP BY varietal
),
-- Unir la variedad más vendida con la información adicional
Bestsellers_Geographic_Report as (
SELECT r.country, r.varietal, r.num_pedidos,
    tc.total_compradores, tc.total_unidades_vendidas, tc.ingreso_total, tc.promedio_unidades_referencia, pc.paises_consumidores_potenciales
FROM ranked r
LEFT JOIN total_compradores tc ON r.country = tc.country AND r.varietal = tc.varietal
LEFT JOIN paises_consumidores pc ON r.varietal = pc.varietal
)
--consulta
select * from Bestsellers_Geographic_Report order by country;
	




--mas proximo
/*
WITH pedidos_anonim 
    AS (select trim(l.contact) as contact, l.orderdate, l.barcode, l.price, l.quantity, o.pais
						from 
						lines_anonym l 
						join 
						(select orderdate, contact, trim(dliv_country) pais from orders_anonym) o
						on (l.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY') 
						and 
						o.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')
						and
						l.orderdate = o.orderdate
						and
						l.contact = o.contact)),
	pedidos_anom_var as (select l.contact as username, l.orderdate, l.barcode, l.price, l.quantity, pais as country, trim(varietal) as varietal
						from 
						pedidos_anonim l join References r on l.barcode = r.barcode join products p on r.product = p.product),
    pedido_cliente AS (SELECT trim(username), orderdate, cl.barcode, cl.price, TO_NUMBER(cl.quantity) as quantity, trim(country) country, trim(varietal) as varietal from Client_Lines cl
						join References r on cl.barcode = r.barcode join products p on r.product = p.product
                        where
                        orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')),
	total_pedidos AS (select * from pedidos_anom_var UNION select * from pedido_cliente),
	variedad_mas_vendida AS (SELECT country, varietal, RANK() OVER (PARTITION BY country ORDER BY COUNT(distinct username) DESC) as ranking
    						FROM total_pedidos 
							GROUP BY country, varietal),
	ranked AS (SELECT country, varietal, ranking 
				FROM variedad_mas_vendida 
				where ranking = 1),
	total_unidades_ingresos AS (SELECT country, varietal, SUM(quantity) AS total_unidades_vendidas, 
								SUM(price * quantity) AS ingreso_total, AVG(quantity) AS promedio_unidades_referencia,
                                COUNT(DISTINCT country) OVER (PARTITION BY varietal) AS paises_consumidores_potenciales
                                FROM total_pedidos 
								GROUP BY country, varietal),
	Bestsellers_Geographic_Report as (SELECT r.country,  r.varietal, t.total_unidades_vendidas, t.ingreso_total, 
										t.promedio_unidades_referencia, t.paises_consumidores_potenciales
										FROM ranked r 
    									inner JOIN total_unidades_ingresos t ON r.country = t.country 
										AND r.varietal = t.varietal)
	select * from Bestsellers_Geographic_Report order by country;
*/
/*WITH pedidos_anonim 
    AS (select l.contact, l.orderdate, l.barcode, l.price, l.quantity, o.dliv_country
						from 
						lines_anonym l 
						join 
						(select orderdate, contact, dliv_country from orders_anonym) o
						on (l.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY') 
						and 
						o.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')
						and
						l.orderdate = o.orderdate
						and
						l.contact = o.contact)),
    pedido_cliente AS (SELECT username, orderdate, barcode, price, TO_NUMBER(quantity), country from Client_Lines 
                        where
                        orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY' )),
    total_pedidos AS (select contact as username, orderdate as orderdate, barcode as barcode, 
						price as price, quantity as quantity, dliv_country as country from pedidos_anonim UNION select * from pedido_cliente),
	juntar_varietal AS (SELECT varietal, country, username, t.orderdate as orderdate, t.barcode as barcode, 
						t.price as price, t.quantity as quantity
				from total_pedidos t join References r on t.barcode = r.barcode
				join products p on r.product = p.product),
	cuenta_varietal AS (select country, varietal, COUNT(varietal) AS cantidad_varietal
						FROM juntar_varietal
						GROUP BY country, varietal),
	pais_variedad AS (SELECT country, max(cantidad_varietal)
    					FROM cuenta_varietal
						group by country)
    select * from pais_variedad;
    

--select * from jun_refe;


WITH pedidos_anonim 
    AS (select l.contact, l.orderdate, l.barcode, l.price, l.quantity, o.dliv_country
						from 
						lines_anonym l 
						join 
						(select orderdate, contact, dliv_country from orders_anonym) o
						on (l.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY') 
						and 
						o.orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')
						and
						l.orderdate = o.orderdate
						and
						l.contact = o.contact)),
	pedidos_anom_var as (select l.contact as username, l.orderdate, l.barcode, l.price, l.quantity, dliv_country as country, varietal
						from 
						pedidos_anonim l join References r on l.barcode = r.barcode join products p on r.product = p.product),
    pedido_cliente AS (SELECT username, orderdate, cl.barcode, cl.price, TO_NUMBER(cl.quantity) as quantity, country, varietal from Client_Lines cl
						join References r on cl.barcode = r.barcode join products p on r.product = p.product
                        where
                        orderdate BETWEEN TO_DATE('01/01/23', 'DD/MM/YY') AND TO_DATE('31/12/23', 'DD/MM/YY')),
	total_pedidos AS (select * from pedidos_anom_var UNION select * from pedido_cliente),
	contado_varietal AS (SELECT varietal, COUNT(varietal) as contacion, country, username from total_pedidos group by country, varietal, username),
	ranked AS (SELECT varietal, country, RANK() OVER (PARTITION BY country ORDER BY contacion DESC) AS varietal_rank
    			FROM contado_varietal)
	select * from ranked;*/



	
--apartado b
